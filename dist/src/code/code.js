figma.showUI(__html__,{width:800,height:600});let r="",d="";const y="figd_dqS-9HS38jaKupAx9-t-LC4j2znS9a0m7icKdX_P";let g="",f=[],p=!1;const E=20;async function w(n=0){if(f.length===0||r!==g){g=r;const c=await fetch(`https://api.figma.com/v1/files/${r}/components`,{headers:{"X-Figma-Token":y}});if(!c.ok)throw new Error("Failed to fetch components metadata");const l=await c.json();f=Object.values(l.meta.components)}const e=f.length,a=Math.min(n+E,e),t=f.slice(n,a);a>=e&&(p=!0);const o=t.map(c=>c.node_id).join(","),s=await fetch(`https://api.figma.com/v1/images/${r}?ids=${o}&format=png`,{headers:{"X-Figma-Token":y}});if(!s.ok)throw new Error("Failed to fetch component images");const i=await s.json();return t.map(c=>{var l,u;return{key:c.key,name:((u=(l=c.containing_frame)==null?void 0:l.containingComponentSet)==null?void 0:u.name)||c.name,thumbnail_url:i.images[c.node_id]||""}})}let m=[];async function h(){if(m.length)return;const n=`https://api.figma.com/v1/files/${r}/components`;try{const e=await fetch(n,{headers:{"X-Figma-Token":y}});if(!e.ok)throw new Error("Failed to fetch components");const a=await e.json();m=Object.values(a.meta.components).map(t=>{var s,i;const o=(i=(s=t.containing_frame)==null?void 0:s.containingComponentSet)==null?void 0:i.name;return{key:t.key,name:o||t.name}}),console.log("Fetched master components:",m),figma.ui.postMessage({type:"result",components:m})}catch(e){console.error("Error fetching master components:",e),figma.notify("Error fetching master components. See console.")}}async function v(n){const e={total:0,valid:0,invalid:0,invalidInstances:[]},a=n.children.filter(t=>t.type==="INSTANCE"&&t.visible);for(const t of a){e.total++;try{const o=await t.getMainComponentAsync();o&&(m.some(i=>i.key===o.key)?e.valid++:(console.log(`Instance mismatch: ${t.name} | component key: ${o.key}`),e.invalid++,e.invalidInstances.push(t)))}catch(o){console.error(`Error processing instance ${t.name}:`,o)}}for(const t of n.children)if(t.type==="FRAME"&&t.visible){const o=await v(t);e.total+=o.total,e.valid+=o.valid,e.invalid+=o.invalid,e.invalidInstances.push(...o.invalidInstances)}return e}async function C(n){try{const e=n.width,a=n.height,t=Math.max(e,a);let o=2;t<100?o=4:t<300?o=3:o=2,console.log(`Exporting node ${n.name} with scale ${o}x`);const s=await n.exportAsync({format:"PNG",constraint:{type:"SCALE",value:o}});M(n.name,n.id,s)}catch(e){console.error(`Error exporting node ${n.name}:`,e),figma.notify(`Failed to export ${n.name}.`)}}function M(n,e,a,t=""){const o=figma.base64Encode(a);figma.ui.postMessage({type:"exportImage",name:n,id:e,data:o,predictedLabel:t})}function I(n){const e=n.toLowerCase();return m.filter(a=>a.name.toLowerCase().includes(e))}async function A(n){await h();const e=I(n),a=[];for(const{name:t,key:o}of e)try{const i=(await figma.importComponentByKeyAsync(o)).createInstance();i.x=i.y=-9999,figma.currentPage.appendChild(i);const c=await i.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),l=figma.base64Encode(c);a.push({name:t,key:o,preview:l}),i.remove()}catch(s){console.error(`Error previewing ${t}:`,s)}return a}figma.ui.onmessage=async n=>{if(n.type==="save-config"){r=n.figmaFileKey,d=n.cnnModelUrl,figma.ui.postMessage({type:"config-saved",figmaFileKey:r,cnnModelUrl:d});return}if(n.type==="load-config"){figma.ui.postMessage({type:"load-config",figmaFileKey:r,cnnModelUrl:d});return}if(n.type==="load-components"){const e=n.figmaFileKey;e&&e!==r&&(r=e,f=[],p=!1,m=[]);try{const a=await w(0);figma.ui.postMessage({type:"components-loaded",components:a,isFullyLoaded:p})}catch(a){figma.ui.postMessage({type:"load-failed",message:a.message})}return}if(n.type==="load-more-components"){try{const e=await w(n.currentLength);figma.ui.postMessage({type:"components-loaded",components:e,isFullyLoaded:p})}catch(e){figma.ui.postMessage({type:"load-failed",message:e.message})}return}if(n.type==="load-master-components"&&(await h(),figma.ui.postMessage({type:"master-components",components:m})),n.type==="fetch-component-preview"){const{key:e}=n;try{const t=(await figma.importComponentByKeyAsync(e)).createInstance();t.x=-9999,t.y=-9999,figma.currentPage.appendChild(t);const o=await t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),s=figma.base64Encode(o);t.remove(),figma.ui.postMessage({type:"component-preview",key:e,preview:s})}catch(a){console.error("Preview error",a)}}if(n.type==="check-components"){n.figmaFileKey,r!==g&&(g=r,f=[],m=[],p=!1,console.log("ðŸ” FIGMA_FILE_KEY updated:",r));const e=figma.currentPage.selection;if(e.length!==1||e[0].type!=="FRAME"){figma.notify("Please select one frame.");return}const a=e[0];if(await h(),m.length===0){figma.notify("Master components not available.");return}const t=await v(a);if(figma.ui.postMessage({type:"clearImages"}),figma.ui.postMessage({type:"summary",total:t.total,valid:t.valid,invalid:t.invalid}),t.invalidInstances.length>0){figma.notify(`${t.invalid} invalid instances found. Exporting images.`);for(const o of t.invalidInstances)await C(o)}else figma.notify("All instances are valid. No images exported.")}if(n.type==="go-to-component")try{const e=await figma.getNodeByIdAsync(n.id);e?(figma.viewport.scrollAndZoomIntoView([e]),figma.currentPage.selection=[e]):figma.notify("Component not found!")}catch(e){console.error("Error fetching node by ID:",e),figma.notify("Error locating component. Check console for details.")}if(n.type==="fetch-master-preview"){const{predictedLabel:e,originalId:a}=n,t=await A(e);figma.ui.postMessage({type:"masterPreview",originalId:a,variants:t})}if(n.type==="user-selected-variant"){const{key:e,originalId:a}=n,t=figma.currentPage.selection,o=t.length===1&&t[0].type==="FRAME"?t[0]:null;if(!o){figma.notify("Please select one frame");return}try{const i=(await figma.importComponentByKeyAsync(e)).createInstance();o.appendChild(i),i.x=o.width/2-i.width/2,i.y=o.height/2-i.height/2,figma.currentPage.selection=[i],figma.viewport.scrollAndZoomIntoView([i]),figma.notify("Component inserted into selected frame and ready to drag!")}catch(s){console.error("Error inserting selected variant:",s),figma.notify("Error inserting component.")}}if(n.type==="insert-component"){const e=figma.currentPage.selection;if(e.length!==1||e[0].type!=="FRAME"){figma.notify("Select one frame");return}const a=e[0];try{const o=(await figma.importComponentByKeyAsync(n.key)).createInstance();a.appendChild(o),o.x=0,o.y=0,figma.currentPage.selection=[o],figma.viewport.scrollAndZoomIntoView([o])}catch(t){console.error("Insert component failed",t),figma.notify("Error inserting component.")}return}};
