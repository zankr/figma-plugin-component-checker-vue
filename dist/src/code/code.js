figma.showUI(__html__,{width:800,height:600});let m="",f="";const d="figd_dqS-9HS38jaKupAx9-t-LC4j2znS9a0m7icKdX_P";let l=[],g=!1;const w=20;async function v(){const n=await figma.clientStorage.getAsync("plugin-config");n&&(m=n.figmaFileKey||"",f=n.cnnModelUrl||"")}(async()=>(await v(),figma.ui.postMessage({type:"load-config",figmaFileKey:m,cnnModelUrl:f})))();async function y(n=0){if(l.length===0){const r=await fetch(`https://api.figma.com/v1/files/${m}/components`,{headers:{"X-Figma-Token":d}});if(!r.ok)throw new Error("Failed to fetch components metadata");const u=await r.json();l=Object.values(u.meta.components)}const e=l.length,o=Math.min(n+w,e),t=l.slice(n,o);o>=e&&(g=!0);const a=t.map(r=>r.node_id).join(","),i=await fetch(`https://api.figma.com/v1/images/${m}?ids=${a}&format=png`,{headers:{"X-Figma-Token":d}});if(!i.ok)throw new Error("Failed to fetch component images");const s=await i.json();return t.map(r=>({key:r.key,name:r.name,thumbnail_url:s.images[r.node_id]||""}))}let c=[];async function p(){const n="figd_dqS-9HS38jaKupAx9-t-LC4j2znS9a0m7icKdX_P",e=`https://api.figma.com/v1/files/${m}/components`;if(c.length===0)try{const o=await fetch(e,{headers:{"X-Figma-Token":n}});if(!o.ok)throw new Error("Failed to fetch components");const t=await o.json();c=Object.values(t.meta.components).map(i=>({key:i.key,name:i.name})),console.log("Fetched master components:",c)}catch(o){console.error("Error fetching components:",o),figma.notify("Error fetching components. Check console for details.")}}async function h(n){const e={total:0,valid:0,invalid:0,invalidInstances:[]},o=n.children.filter(t=>t.type==="INSTANCE"&&t.visible);for(const t of o){e.total++;try{const a=await t.getMainComponentAsync();a?c.some(s=>s.key===a.key)?e.valid++:(console.log(`Instance mismatch: ${t.name}`),e.invalid++,e.invalidInstances.push(t)):(console.log(`Instance tanpa main component: ${t.name}`),e.invalid++,e.invalidInstances.push(t))}catch(a){console.error(`Error processing instance ${t.name}:`,a)}}for(const t of n.children)if(t.type==="FRAME"&&t.visible){const a=await h(t);e.total+=a.total,e.valid+=a.valid,e.invalid+=a.invalid,e.invalidInstances.push(...a.invalidInstances)}return e}async function C(n){try{const e=n.width,o=n.height,t=Math.max(e,o);let a=2;t<100?a=4:t<300?a=3:a=2,console.log(`Exporting node ${n.name} with scale ${a}x`);const i=await n.exportAsync({format:"PNG",constraint:{type:"SCALE",value:a}});E(n.name,n.id,i)}catch(e){console.error(`Error exporting node ${n.name}:`,e),figma.notify(`Failed to export ${n.name}.`)}}function E(n,e,o,t="",a=""){const i=figma.base64Encode(o);figma.ui.postMessage({type:"exportImage",name:n,id:e,data:i,predictedLabel:t,confidence:a})}function I(n){const e=n.toLowerCase();let o=c.find(t=>t.name.toLowerCase()===e);return o||(o=c.find(t=>t.name.toLowerCase().includes(e))),o}function A(n){const e=n.toLowerCase();return c.filter(o=>o.name.toLowerCase().includes(e))}async function M(n){await p();const e=I(n);if(!e)return figma.notify(`Master component dengan nama '${n}' tidak ditemukan.`),null;try{const t=(await figma.importComponentByKeyAsync(e.key)).createInstance();t.x=-1e3,t.y=-1e3,figma.currentPage.appendChild(t);const a=await t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),i=figma.base64Encode(a);return t.remove(),i}catch(o){return console.error("Error generating master preview:",o),null}}async function k(n){await p();const e=A(n),o=[];for(const t of e)try{const i=(await figma.importComponentByKeyAsync(t.key)).createInstance();i.x=-1e3,i.y=-1e3,figma.currentPage.appendChild(i);const s=await i.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),r=figma.base64Encode(s);o.push({name:t.name,key:t.key,preview:r}),i.remove()}catch(a){console.error(`Error generating preview for ${t.name}:`,a)}return o}figma.ui.onmessage=async n=>{if(n.type==="load-components"){try{const e=await y(0);figma.ui.postMessage({type:"components-loaded",components:e,isFullyLoaded:g})}catch(e){figma.ui.postMessage({type:"load-failed",message:e.message})}return}if(n.type==="load-more-components"){try{const e=await y(n.currentLength);figma.ui.postMessage({type:"components-loaded",components:e,isFullyLoaded:g})}catch(e){figma.ui.postMessage({type:"load-failed",message:e.message})}return}if(n.type==="load-master-components"&&(await p(),figma.ui.postMessage({type:"master-components",components:c})),n.type==="fetch-component-preview"){const{key:e}=n;try{const t=(await figma.importComponentByKeyAsync(e)).createInstance();t.x=-9999,t.y=-9999,figma.currentPage.appendChild(t);const a=await t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),i=figma.base64Encode(a);t.remove(),figma.ui.postMessage({type:"component-preview",key:e,preview:i})}catch(o){console.error("Preview error",o)}}if(n.type==="save-config"){m=n.figmaFileKey,f=n.cnnModelUrl,await figma.clientStorage.setAsync("plugin-config",{figmaFileKey:m,cnnModelUrl:f});return}if(n.type==="check-components"){const e=figma.currentPage.selection;if(e.length!==1||e[0].type!=="FRAME"){figma.notify("Please select one frame.");return}const o=e[0];if(await p(),c.length===0){figma.notify("Master components not available.");return}const t=await h(o);if(figma.ui.postMessage({type:"clearImages"}),figma.ui.postMessage({type:"summary",total:t.total,valid:t.valid,invalid:t.invalid}),t.invalidInstances.length>0){figma.notify(`${t.invalid} invalid instances found. Exporting images.`);for(const a of t.invalidInstances)await C(a)}else figma.notify("All instances are valid. No images exported.")}if(n.type==="go-to-component")try{const e=await figma.getNodeByIdAsync(n.id);e?(figma.viewport.scrollAndZoomIntoView([e]),figma.currentPage.selection=[e]):figma.notify("Component not found!")}catch(e){console.error("Error fetching node by ID:",e),figma.notify("Error locating component. Check console for details.")}if(n.type==="fetch-master-preview"){const{predictedLabel:e,originalId:o}=n,t=await k(e);if(!t||t.length===0){const a=await M(e);figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:e,variants:a?[{name:e,key:"",preview:a}]:[]})}else figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:e,variants:t})}if(n.type==="user-selected-variant"){const{key:e,originalId:o}=n,t=figma.currentPage.selection,a=t.length===1&&t[0].type==="FRAME"?t[0]:null;if(!a){figma.notify("Please select one frame");return}try{const s=(await figma.importComponentByKeyAsync(e)).createInstance();a.appendChild(s),s.x=a.width/2-s.width/2,s.y=a.height/2-s.height/2,figma.currentPage.selection=[s],figma.viewport.scrollAndZoomIntoView([s]),figma.notify("Component inserted into selected frame and ready to drag!")}catch(i){console.error("Error inserting selected variant:",i),figma.notify("Error inserting component.")}}if(n.type==="insert-component"){const e=figma.currentPage.selection;if(e.length!==1||e[0].type!=="FRAME"){figma.notify("Select one frame");return}const o=e[0];try{const a=(await figma.importComponentByKeyAsync(n.key)).createInstance();o.appendChild(a),a.x=0,a.y=0,figma.currentPage.selection=[a],figma.viewport.scrollAndZoomIntoView([a])}catch(t){console.error("Insert component failed",t),figma.notify("Error inserting component.")}return}};
