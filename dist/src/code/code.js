figma.showUI(__html__,{width:800,height:600});let r=[];async function c(){const a="figd_dqS-9HS38jaKupAx9-t-LC4j2znS9a0m7icKdX_P",o="https://api.figma.com/v1/files/HIHSBFb6tatYWQYl2LudlV/components";if(r.length===0)try{const e=await fetch(o,{headers:{"X-Figma-Token":a}});if(!e.ok)throw new Error("Failed to fetch components");const t=await e.json();r=Object.values(t.meta.components).map(s=>({key:s.key,name:s.name})),console.log("Fetched master components:",r)}catch(e){console.error("Error fetching components:",e),figma.notify("Error fetching components. Check console for details.")}}async function l(a){const n={total:0,valid:0,invalid:0,invalidInstances:[]},o=a.children.filter(e=>e.type==="INSTANCE"&&e.visible);for(const e of o){n.total++;try{const t=await e.getMainComponentAsync();t?r.some(s=>s.key===t.key)?n.valid++:(console.log(`Instance mismatch: ${e.name}`),n.invalid++,n.invalidInstances.push(e)):(console.log(`Instance tanpa main component: ${e.name}`),n.invalid++,n.invalidInstances.push(e))}catch(t){console.error(`Error processing instance ${e.name}:`,t)}}for(const e of a.children)if(e.type==="FRAME"&&e.visible){const t=await l(e);n.total+=t.total,n.valid+=t.valid,n.invalid+=t.invalid,n.invalidInstances.push(...t.invalidInstances)}return n}async function f(a){try{const n=a.width,o=a.height,e=Math.max(n,o);let t=2;e<100?t=4:e<300?t=3:t=2,console.log(`Exporting node ${a.name} with scale ${t}x`);const i=await a.exportAsync({format:"PNG",constraint:{type:"SCALE",value:t}});p(a.name,a.id,i)}catch(n){console.error(`Error exporting node ${a.name}:`,n),figma.notify(`Failed to export ${a.name}.`)}}function p(a,n,o,e="",t=""){const i=figma.base64Encode(o);figma.ui.postMessage({type:"exportImage",name:a,id:n,data:i,predictedLabel:e,confidence:t})}function g(a){const n=a.toLowerCase();let o=r.find(e=>e.name.toLowerCase()===n);return o||(o=r.find(e=>e.name.toLowerCase().includes(n))),o}function d(a){const n=a.toLowerCase();return r.filter(o=>o.name.toLowerCase().includes(n))}async function y(a){await c();const n=g(a);if(!n)return figma.notify(`Master component dengan nama '${a}' tidak ditemukan.`),null;try{const e=(await figma.importComponentByKeyAsync(n.key)).createInstance();e.x=-1e3,e.y=-1e3,figma.currentPage.appendChild(e);const t=await e.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),i=figma.base64Encode(t);return e.remove(),i}catch(o){return console.error("Error generating master preview:",o),null}}async function h(a){await c();const n=d(a),o=[];for(const e of n)try{const i=(await figma.importComponentByKeyAsync(e.key)).createInstance();i.x=-1e3,i.y=-1e3,figma.currentPage.appendChild(i);const s=await i.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),m=figma.base64Encode(s);o.push({name:e.name,key:e.key,preview:m}),i.remove()}catch(t){console.error(`Error generating preview for ${e.name}:`,t)}return o}figma.ui.onmessage=async a=>{if(a.type==="check-components"){const n=figma.currentPage.selection;if(n.length!==1||n[0].type!=="FRAME"){figma.notify("Please select one frame.");return}const o=n[0];if(await c(),r.length===0){figma.notify("Master components not available.");return}const e=await l(o);if(figma.ui.postMessage({type:"clearImages"}),figma.ui.postMessage({type:"summary",total:e.total,valid:e.valid,invalid:e.invalid}),e.invalidInstances.length>0){figma.notify(`${e.invalid} invalid instances found. Exporting images.`);for(const t of e.invalidInstances)await f(t)}else figma.notify("All instances are valid. No images exported.")}if(a.type==="go-to-component")try{const n=await figma.getNodeByIdAsync(a.id);n?(figma.viewport.scrollAndZoomIntoView([n]),figma.currentPage.selection=[n]):figma.notify("Component not found!")}catch(n){console.error("Error fetching node by ID:",n),figma.notify("Error locating component. Check console for details.")}if(a.type==="fetch-master-preview"){const{predictedLabel:n,originalId:o}=a,e=await h(n);if(!e||e.length===0){const t=await y(n);figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:n,variants:t?[{name:n,key:"",preview:t}]:[]})}else figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:n,variants:e})}if(a.type==="user-selected-variant")try{const{key:n,originalId:o}=a,t=(await figma.importComponentByKeyAsync(n)).createInstance(),i=figma.currentPage.selection;let s=null;i.length===1&&i[0].type==="FRAME"&&(s=i[0]),s?(s.appendChild(t),t.x=s.width/2-t.width/2,t.y=s.height/2-t.height/2,figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]),figma.notify("Component inserted into selected frame and ready to drag!")):(figma.currentPage.appendChild(t),t.x=100,t.y=100,figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]),figma.notify("Component inserted into page and ready to drag!"))}catch(n){console.error("Error inserting selected variant:",n),figma.notify("Error inserting component.")}};
