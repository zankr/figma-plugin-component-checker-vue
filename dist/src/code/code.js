figma.showUI(__html__,{width:800,height:600});let c="",l="";async function p(){const t=await figma.clientStorage.getAsync("plugin-config");t&&(c=t.figmaFileKey||"",l=t.cnnModelUrl||"")}(async()=>(await p(),figma.showUI(__html__,{width:800,height:600}),figma.ui.postMessage({type:"load-config",figmaFileKey:c,cnnModelUrl:l})))();let r=[];async function m(){const t="figd_dqS-9HS38jaKupAx9-t-LC4j2znS9a0m7icKdX_P",n=`https://api.figma.com/v1/files/${c}/components`;if(r.length===0)try{const o=await fetch(n,{headers:{"X-Figma-Token":t}});if(!o.ok)throw new Error("Failed to fetch components");const e=await o.json();r=Object.values(e.meta.components).map(i=>({key:i.key,name:i.name})),console.log("Fetched master components:",r)}catch(o){console.error("Error fetching components:",o),figma.notify("Error fetching components. Check console for details.")}}async function f(t){const n={total:0,valid:0,invalid:0,invalidInstances:[]},o=t.children.filter(e=>e.type==="INSTANCE"&&e.visible);for(const e of o){n.total++;try{const a=await e.getMainComponentAsync();a?r.some(s=>s.key===a.key)?n.valid++:(console.log(`Instance mismatch: ${e.name}`),n.invalid++,n.invalidInstances.push(e)):(console.log(`Instance tanpa main component: ${e.name}`),n.invalid++,n.invalidInstances.push(e))}catch(a){console.error(`Error processing instance ${e.name}:`,a)}}for(const e of t.children)if(e.type==="FRAME"&&e.visible){const a=await f(e);n.total+=a.total,n.valid+=a.valid,n.invalid+=a.invalid,n.invalidInstances.push(...a.invalidInstances)}return n}async function d(t){try{const n=t.width,o=t.height,e=Math.max(n,o);let a=2;e<100?a=4:e<300?a=3:a=2,console.log(`Exporting node ${t.name} with scale ${a}x`);const i=await t.exportAsync({format:"PNG",constraint:{type:"SCALE",value:a}});y(t.name,t.id,i)}catch(n){console.error(`Error exporting node ${t.name}:`,n),figma.notify(`Failed to export ${t.name}.`)}}function y(t,n,o,e="",a=""){const i=figma.base64Encode(o);figma.ui.postMessage({type:"exportImage",name:t,id:n,data:i,predictedLabel:e,confidence:a})}function h(t){const n=t.toLowerCase();let o=r.find(e=>e.name.toLowerCase()===n);return o||(o=r.find(e=>e.name.toLowerCase().includes(n))),o}function u(t){const n=t.toLowerCase();return r.filter(o=>o.name.toLowerCase().includes(n))}async function w(t){await m();const n=h(t);if(!n)return figma.notify(`Master component dengan nama '${t}' tidak ditemukan.`),null;try{const e=(await figma.importComponentByKeyAsync(n.key)).createInstance();e.x=-1e3,e.y=-1e3,figma.currentPage.appendChild(e);const a=await e.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),i=figma.base64Encode(a);return e.remove(),i}catch(o){return console.error("Error generating master preview:",o),null}}async function v(t){await m();const n=u(t),o=[];for(const e of n)try{const i=(await figma.importComponentByKeyAsync(e.key)).createInstance();i.x=-1e3,i.y=-1e3,figma.currentPage.appendChild(i);const s=await i.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}}),g=figma.base64Encode(s);o.push({name:e.name,key:e.key,preview:g}),i.remove()}catch(a){console.error(`Error generating preview for ${e.name}:`,a)}return o}figma.ui.onmessage=async t=>{if(t.type==="save-config"){c=t.figmaFileKey,l=t.cnnModelUrl,await figma.clientStorage.setAsync("plugin-config",{figmaFileKey:c,cnnModelUrl:l});return}if(t.type==="check-components"){const n=figma.currentPage.selection;if(n.length!==1||n[0].type!=="FRAME"){figma.notify("Please select one frame.");return}const o=n[0];if(await m(),r.length===0){figma.notify("Master components not available.");return}const e=await f(o);if(figma.ui.postMessage({type:"clearImages"}),figma.ui.postMessage({type:"summary",total:e.total,valid:e.valid,invalid:e.invalid}),e.invalidInstances.length>0){figma.notify(`${e.invalid} invalid instances found. Exporting images.`);for(const a of e.invalidInstances)await d(a)}else figma.notify("All instances are valid. No images exported.")}if(t.type==="go-to-component")try{const n=await figma.getNodeByIdAsync(t.id);n?(figma.viewport.scrollAndZoomIntoView([n]),figma.currentPage.selection=[n]):figma.notify("Component not found!")}catch(n){console.error("Error fetching node by ID:",n),figma.notify("Error locating component. Check console for details.")}if(t.type==="fetch-master-preview"){const{predictedLabel:n,originalId:o}=t,e=await v(n);if(!e||e.length===0){const a=await w(n);figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:n,variants:a?[{name:n,key:"",preview:a}]:[]})}else figma.ui.postMessage({type:"masterPreview",originalId:o,predictedLabel:n,variants:e})}if(t.type==="user-selected-variant"){const{key:n,originalId:o}=t,e=figma.currentPage.selection,a=e.length===1&&e[0].type==="FRAME"?e[0]:null;if(!a){figma.notify("Please select one frame");return}try{const s=(await figma.importComponentByKeyAsync(n)).createInstance();a.appendChild(s),s.x=a.width/2-s.width/2,s.y=a.height/2-s.height/2,figma.currentPage.selection=[s],figma.viewport.scrollAndZoomIntoView([s]),figma.notify("Component inserted into selected frame and ready to drag!")}catch(i){console.error("Error inserting selected variant:",i),figma.notify("Error inserting component.")}}};
